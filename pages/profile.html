<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Profile â€“ Engibrief</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/auth.css">
  <link rel="stylesheet" href="/css/profile.css">
  <link rel="icon" href="/assets/google-icon.png" />
</head>

<body>

<!-- =========================
     NAVBAR
========================= -->
<header class="navbar">
  <a href="/index.html" class="brand">
    <img src="/assets/logo.svg" alt="Engibrief Logo" class="brand-icon">
    <span class="brand-text">
        <span class="brand-eng">Eng</span><span class="brand-brief">ibrief</span>
    </span>
  </a>

  <!-- Hamburger -->
  <button class="hamburger" id="hamburgerBtn" aria-label="Menu">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <nav class="nav-links" id="navLinks">
    <a href="/index.html">Home</a>
    <a href="/pages/products.html">Exclusive E-Books</a>
    <a href="/pages/support.html">Support</a>
    <a href="/pages/products-rzp.html">Quick Buy</a>

    <div id="authArea"></div>
  </nav>
</header>

<!-- =========================
     PROFILE SECTION
========================= -->
<section class="profile-wrapper">
  <div class="profile-card">

    <div class="profile-avatar">
      <span id="avatarInitial">U</span>
    </div>

    <h2>My Profile</h2>
    <p class="profile-subtitle">Manage your account information</p>

    <div class="profile-form">

      <div class="field">
        <label>Email</label>
        <input type="email" id="profileEmail" disabled />
      </div>

      <div class="field">
        <label>Full Name</label>
        <input type="text" id="profileName" placeholder="Your full name" />
      </div>

      <button class="btn-primary" id="saveProfileBtn">
        Save Changes
      </button>

      <button class="btn-outline danger" id="logoutBtn">
        Logout
      </button>

    </div>

  </div>
</section>

<!-- ðŸ”” TOAST -->
<div id="toast" class="toast hidden"></div>

<!-- =========================
     PROFILE LOGIC
========================= -->
<script type="module">
  import { supabase } from "/js/supabase.js";

  function showToast(message, type = "info", duration = 3000) {
    const toast = document.getElementById("toast");
    if (!toast) return;

    toast.textContent = message;
    toast.className = `toast ${type} show`;

    setTimeout(() => {
      toast.className = "toast hidden";
    }, duration);
  }

  document.addEventListener("DOMContentLoaded", async () => {

    const emailInput = document.getElementById("profileEmail");
    const nameInput = document.getElementById("profileName");
    const avatar = document.getElementById("avatarInitial");
    const saveBtn = document.getElementById("saveProfileBtn");

    /* =========================
       AUTH GUARD
    ========================= */
    const { data: { session } } = await supabase.auth.getSession();

    if (!session) {
      window.location.replace("/pages/auth.html");
      return;
    }

    const user = session.user;

    /* =========================
       BASIC INFO
    ========================= */
    emailInput.value = user.email;
    avatar.textContent = user.email.charAt(0).toUpperCase();

    /* =========================
       LOAD PROFILE (DB)
    ========================= */
    const { data: profile, error } = await supabase
      .from("profiles")
      .select("full_name")
      .eq("id", user.id)
      .single();

    if (!error && profile?.full_name) {
      nameInput.value = profile.full_name;
    } else if (user.user_metadata?.full_name) {
      nameInput.value = user.user_metadata.full_name;
    }

    /* =========================
       SAVE PROFILE
    ========================= */
    saveBtn.addEventListener("click", async () => {
      const fullName = nameInput.value.trim();

      if (!fullName) {
        showToast("Name cannot be empty", "error");
        return;
      }

      saveBtn.disabled = true;

      /* 1ï¸âƒ£ Update profiles table */
      const { error: profileError } = await supabase
        .from("profiles")
        .upsert({
          id: user.id,
          full_name: fullName
        });

      if (profileError) {
        showToast(profileError.message, "error");
        saveBtn.disabled = false;
        return;
      }

      /* 2ï¸âƒ£ Update JWT user metadata */
      const { error: metaError } = await supabase.auth.updateUser({
        data: { full_name: fullName }
      });

      if (metaError) {
        showToast(metaError.message, "error");
        saveBtn.disabled = false;
        return;
      }

      /* 3ï¸âƒ£ Refresh navbar instantly */
      if (typeof window.renderNavbar === "function") {
        await window.renderNavbar();
      }

      showToast("Profile updated successfully", "success");
      saveBtn.disabled = false;
    });

    /* =========================
       LOGOUT
    ========================= */
    document.getElementById("logoutBtn")
      .addEventListener("click", async () => {
        await supabase.auth.signOut();
        window.location.replace("/pages/auth.html");
      });
  });
</script>


<!-- ðŸ” NAVBAR AUTH RENDERER -->
<script type="module" src="/js/app.js"></script>
<script type="module" src="/js/profile-guard.js"></script>



</body>
</html>
